{"ast":null,"code":"import _slicedToArray from \"C:/pproject-files/new-app/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport * as React from 'react';\nimport { GridEvents } from '../../../models/events';\nimport { useGridApiEventHandler } from '../../utils/useGridApiEventHandler';\nimport { useGridApiMethod } from '../../utils/useGridApiMethod';\nimport { useGridLogger } from '../../utils/useGridLogger';\nimport { gridRowsLookupSelector } from '../rows/gridRowsSelector';\nimport { isGridCellRoot } from '../../../utils/domUtils';\nimport { gridSelectionStateSelector, selectedGridRowsSelector, selectedIdsLookupSelector } from './gridSelectionSelector';\nimport { gridPaginatedVisibleSortedGridRowIdsSelector } from '../pagination';\nimport { gridVisibleSortedRowIdsSelector } from '../filter/gridFilterSelector';\nimport { GRID_CHECKBOX_SELECTION_COL_DEF, GRID_ACTIONS_COLUMN_TYPE } from '../../../colDef';\nimport { GridCellModes } from '../../../models/gridEditRowModel';\nimport { isKeyboardEvent } from '../../../utils/keyboardUtils';\nimport { getVisibleRows } from '../../utils/useGridVisibleRows';\n\nvar getSelectionModelPropValue = function getSelectionModelPropValue(selectionModelProp, prevSelectionModel) {\n  if (selectionModelProp == null) {\n    return selectionModelProp;\n  }\n\n  if (Array.isArray(selectionModelProp)) {\n    return selectionModelProp;\n  }\n\n  if (prevSelectionModel && prevSelectionModel[0] === selectionModelProp) {\n    return prevSelectionModel;\n  }\n\n  return [selectionModelProp];\n};\n\nexport var selectionStateInitializer = function selectionStateInitializer(state, props) {\n  var _getSelectionModelPro;\n\n  return _extends({}, state, {\n    selection: (_getSelectionModelPro = getSelectionModelPropValue(props.selectionModel)) != null ? _getSelectionModelPro : []\n  });\n};\n/**\n * @requires useGridRows (state, method)\n * @requires useGridParamsApi (method)\n */\n\nexport var useGridSelection = function useGridSelection(apiRef, props) {\n  var logger = useGridLogger(apiRef, 'useGridSelection');\n  var propSelectionModel = React.useMemo(function () {\n    return getSelectionModelPropValue(props.selectionModel, gridSelectionStateSelector(apiRef.current.state));\n  }, [apiRef, props.selectionModel]);\n  var lastRowToggled = React.useRef(null);\n  apiRef.current.unstable_updateControlState({\n    stateId: 'selection',\n    propModel: propSelectionModel,\n    propOnChange: props.onSelectionModelChange,\n    stateSelector: gridSelectionStateSelector,\n    changeEvent: GridEvents.selectionChange\n  });\n  var checkboxSelection = props.checkboxSelection,\n      disableMultipleSelection = props.disableMultipleSelection,\n      disableSelectionOnClick = props.disableSelectionOnClick,\n      isRowSelectable = props.isRowSelectable,\n      pagination = props.pagination,\n      paginationMode = props.paginationMode;\n  var canHaveMultipleSelection = !disableMultipleSelection || checkboxSelection;\n  var expandRowRangeSelection = React.useCallback(function (id) {\n    var _lastRowToggled$curre;\n\n    var endId = id;\n    var startId = (_lastRowToggled$curre = lastRowToggled.current) != null ? _lastRowToggled$curre : id;\n    var isSelected = apiRef.current.isRowSelected(id);\n\n    if (isSelected) {\n      var visibleRowIds = gridVisibleSortedRowIdsSelector(apiRef);\n      var startIndex = visibleRowIds.findIndex(function (rowId) {\n        return rowId === startId;\n      });\n      var endIndex = visibleRowIds.findIndex(function (rowId) {\n        return rowId === endId;\n      });\n\n      if (startIndex > endIndex) {\n        endId = visibleRowIds[endIndex + 1];\n      } else {\n        endId = visibleRowIds[endIndex - 1];\n      }\n    }\n\n    lastRowToggled.current = id;\n    apiRef.current.selectRowRange({\n      startId: startId,\n      endId: endId\n    }, !isSelected);\n  }, [apiRef]);\n  /**\n   * API METHODS\n   */\n\n  var setSelectionModel = React.useCallback(function (model) {\n    var currentModel = gridSelectionStateSelector(apiRef.current.state);\n\n    if (currentModel !== model) {\n      logger.debug(\"Setting selection model\");\n      apiRef.current.setState(function (state) {\n        return _extends({}, state, {\n          selection: model\n        });\n      });\n      apiRef.current.forceUpdate();\n    }\n  }, [apiRef, logger]);\n  var isRowSelected = React.useCallback(function (id) {\n    return gridSelectionStateSelector(apiRef.current.state).includes(id);\n  }, [apiRef]);\n  var getSelectedRows = React.useCallback(function () {\n    return selectedGridRowsSelector(apiRef);\n  }, [apiRef]);\n  var selectRow = React.useCallback(function (id) {\n    var isSelected = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n    var resetSelection = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n\n    if (isRowSelectable && !isRowSelectable(apiRef.current.getRowParams(id))) {\n      return;\n    }\n\n    lastRowToggled.current = id;\n\n    if (resetSelection) {\n      logger.debug(\"Setting selection for row \".concat(id));\n      apiRef.current.setSelectionModel(isSelected ? [id] : []);\n    } else {\n      logger.debug(\"Toggling selection for row \".concat(id));\n      var selection = gridSelectionStateSelector(apiRef.current.state);\n      var newSelection = selection.filter(function (el) {\n        return el !== id;\n      });\n\n      if (isSelected) {\n        newSelection.push(id);\n      }\n\n      var isSelectionValid = newSelection.length < 2 || canHaveMultipleSelection;\n\n      if (isSelectionValid) {\n        apiRef.current.setSelectionModel(newSelection);\n      }\n    }\n  }, [apiRef, isRowSelectable, logger, canHaveMultipleSelection]);\n  var selectRows = React.useCallback(function (ids) {\n    var isSelected = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n    var resetSelection = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n    logger.debug(\"Setting selection for several rows\");\n    var selectableIds = isRowSelectable ? ids.filter(function (id) {\n      return isRowSelectable(apiRef.current.getRowParams(id));\n    }) : ids;\n    var newSelection;\n\n    if (resetSelection) {\n      newSelection = isSelected ? selectableIds : [];\n    } else {\n      // We clone the existing object to avoid mutating the same object returned by the selector to others part of the project\n      var selectionLookup = _extends({}, selectedIdsLookupSelector(apiRef));\n\n      selectableIds.forEach(function (id) {\n        if (isSelected) {\n          selectionLookup[id] = id;\n        } else {\n          delete selectionLookup[id];\n        }\n      });\n      newSelection = Object.values(selectionLookup);\n    }\n\n    var isSelectionValid = newSelection.length < 2 || canHaveMultipleSelection;\n\n    if (isSelectionValid) {\n      apiRef.current.setSelectionModel(newSelection);\n    }\n  }, [apiRef, isRowSelectable, logger, canHaveMultipleSelection]);\n  var selectRowRange = React.useCallback(function (_ref) {\n    var startId = _ref.startId,\n        endId = _ref.endId;\n    var isSelected = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : true;\n    var resetSelection = arguments.length > 2 ? arguments[2] : undefined;\n\n    if (!apiRef.current.getRow(startId) || !apiRef.current.getRow(endId)) {\n      return;\n    }\n\n    logger.debug(\"Expanding selection from row \".concat(startId, \" to row \").concat(endId));\n    var visibleRowIds = gridVisibleSortedRowIdsSelector(apiRef);\n    var startIndex = visibleRowIds.indexOf(startId);\n    var endIndex = visibleRowIds.indexOf(endId);\n\n    var _ref2 = startIndex > endIndex ? [endIndex, startIndex] : [startIndex, endIndex],\n        _ref3 = _slicedToArray(_ref2, 2),\n        start = _ref3[0],\n        end = _ref3[1];\n\n    var rowsBetweenStartAndEnd = visibleRowIds.slice(start, end + 1);\n    apiRef.current.selectRows(rowsBetweenStartAndEnd, isSelected, resetSelection);\n  }, [apiRef, logger]);\n  var selectionApi = {\n    selectRow: selectRow,\n    selectRows: selectRows,\n    selectRowRange: selectRowRange,\n    setSelectionModel: setSelectionModel,\n    getSelectedRows: getSelectedRows,\n    isRowSelected: isRowSelected\n  };\n  useGridApiMethod(apiRef, selectionApi, 'GridSelectionApi');\n  /**\n   * EVENTS\n   */\n\n  var removeOutdatedSelection = React.useCallback(function () {\n    var currentSelection = gridSelectionStateSelector(apiRef.current.state);\n    var rowsLookup = gridRowsLookupSelector(apiRef); // We clone the existing object to avoid mutating the same object returned by the selector to others part of the project\n\n    var selectionLookup = _extends({}, selectedIdsLookupSelector(apiRef));\n\n    var hasChanged = false;\n    currentSelection.forEach(function (id) {\n      if (!rowsLookup[id]) {\n        delete selectionLookup[id];\n        hasChanged = true;\n      }\n    });\n\n    if (hasChanged) {\n      apiRef.current.setSelectionModel(Object.values(selectionLookup));\n    }\n  }, [apiRef]);\n  var handleSingleRowSelection = React.useCallback(function (id, event) {\n    var hasCtrlKey = event.metaKey || event.ctrlKey; // multiple selection is only allowed if:\n    // - it is a checkboxSelection\n    // - it is a keyboard selection\n    // - CTRL is pressed\n\n    var isMultipleSelectionDisabled = !checkboxSelection && !hasCtrlKey && !isKeyboardEvent(event);\n    var resetSelection = !canHaveMultipleSelection || isMultipleSelectionDisabled;\n    var isSelected = apiRef.current.isRowSelected(id);\n\n    if (resetSelection) {\n      apiRef.current.selectRow(id, !isMultipleSelectionDisabled ? !isSelected : true, true);\n    } else {\n      apiRef.current.selectRow(id, !isSelected, false);\n    }\n  }, [apiRef, canHaveMultipleSelection, checkboxSelection]);\n  var handleCellClick = React.useCallback(function (params, event) {\n    if (disableSelectionOnClick) {\n      return;\n    }\n\n    if (params.field === GRID_CHECKBOX_SELECTION_COL_DEF.field) {\n      // click on checkbox should not trigger row selection\n      return;\n    }\n\n    if (params.field === '__detail_panel_toggle__') {\n      // click to open the detail panel should not select the row\n      return;\n    }\n\n    if (params.field) {\n      var column = apiRef.current.getColumn(params.field);\n\n      if (column.type === GRID_ACTIONS_COLUMN_TYPE) {\n        return;\n      }\n    }\n\n    if (event.shiftKey && (canHaveMultipleSelection || checkboxSelection)) {\n      expandRowRangeSelection(params.id);\n    } else {\n      handleSingleRowSelection(params.id, event);\n    }\n  }, [disableSelectionOnClick, canHaveMultipleSelection, checkboxSelection, apiRef, expandRowRangeSelection, handleSingleRowSelection]);\n  var preventSelectionOnShift = React.useCallback(function (params, event) {\n    if (canHaveMultipleSelection && event.shiftKey) {\n      var _window$getSelection;\n\n      (_window$getSelection = window.getSelection()) == null ? void 0 : _window$getSelection.removeAllRanges();\n    }\n  }, [canHaveMultipleSelection]);\n  var handleRowSelectionCheckboxChange = React.useCallback(function (params, event) {\n    if (event.nativeEvent.shiftKey) {\n      expandRowRangeSelection(params.id);\n    } else {\n      apiRef.current.selectRow(params.id, params.value);\n    }\n  }, [apiRef, expandRowRangeSelection]);\n  var handleHeaderSelectionCheckboxChange = React.useCallback(function (params) {\n    var shouldLimitSelectionToCurrentPage = props.checkboxSelectionVisibleOnly && props.pagination;\n    var rowsToBeSelected = shouldLimitSelectionToCurrentPage ? gridPaginatedVisibleSortedGridRowIdsSelector(apiRef) : gridVisibleSortedRowIdsSelector(apiRef);\n    apiRef.current.selectRows(rowsToBeSelected, params.value);\n  }, [apiRef, props.checkboxSelectionVisibleOnly, props.pagination]);\n  var handleCellKeyDown = React.useCallback(function (params, event) {\n    // Ignore portal\n    // Do not apply shortcuts if the focus is not on the cell root component\n    // TODO replace with !event.currentTarget.contains(event.target as Element)\n    if (!isGridCellRoot(event.target)) {\n      return;\n    } // Get the most recent params because the cell mode may have changed by another listener\n\n\n    var cellParams = apiRef.current.getCellParams(params.id, params.field);\n    var isEditMode = cellParams.cellMode === GridCellModes.Edit;\n\n    if (isEditMode) {\n      return;\n    }\n\n    if (event.key === ' ' && event.shiftKey) {\n      event.preventDefault();\n      handleSingleRowSelection(cellParams.id, event);\n      return;\n    }\n\n    if (event.key.toLowerCase() === 'a' && (event.ctrlKey || event.metaKey)) {\n      event.preventDefault();\n      selectRows(apiRef.current.getAllRowIds(), true);\n    }\n  }, [apiRef, handleSingleRowSelection, selectRows]);\n  useGridApiEventHandler(apiRef, GridEvents.visibleRowsSet, removeOutdatedSelection);\n  useGridApiEventHandler(apiRef, GridEvents.cellClick, handleCellClick);\n  useGridApiEventHandler(apiRef, GridEvents.rowSelectionCheckboxChange, handleRowSelectionCheckboxChange);\n  useGridApiEventHandler(apiRef, GridEvents.headerSelectionCheckboxChange, handleHeaderSelectionCheckboxChange);\n  useGridApiEventHandler(apiRef, GridEvents.cellMouseDown, preventSelectionOnShift);\n  useGridApiEventHandler(apiRef, GridEvents.cellKeyDown, handleCellKeyDown);\n  /**\n   * EFFECTS\n   */\n\n  React.useEffect(function () {\n    if (propSelectionModel !== undefined) {\n      apiRef.current.setSelectionModel(propSelectionModel);\n    }\n  }, [apiRef, propSelectionModel]);\n  var isStateControlled = propSelectionModel != null;\n  React.useEffect(function () {\n    if (isStateControlled) {\n      return;\n    } // isRowSelectable changed\n\n\n    var currentSelection = gridSelectionStateSelector(apiRef.current.state);\n\n    if (isRowSelectable) {\n      var newSelection = currentSelection.filter(function (id) {\n        return isRowSelectable(apiRef.current.getRowParams(id));\n      });\n\n      if (newSelection.length < currentSelection.length) {\n        apiRef.current.setSelectionModel(newSelection);\n      }\n    }\n  }, [apiRef, isRowSelectable, isStateControlled]);\n  React.useEffect(function () {\n    var currentSelection = gridSelectionStateSelector(apiRef.current.state);\n\n    if (!canHaveMultipleSelection && currentSelection.length > 1) {\n      var _getVisibleRows = getVisibleRows(apiRef, {\n        pagination: pagination,\n        paginationMode: paginationMode\n      }),\n          currentPageRows = _getVisibleRows.rows;\n\n      var currentPageRowsLookup = currentPageRows.reduce(function (acc, _ref4) {\n        var id = _ref4.id;\n        acc[id] = true;\n        return acc;\n      }, {});\n      var firstSelectableRow = currentSelection.find(function (id) {\n        var isSelectable = true;\n\n        if (isRowSelectable) {\n          isSelectable = isRowSelectable(apiRef.current.getRowParams(id));\n        }\n\n        return isSelectable && currentPageRowsLookup[id]; // Check if the row is in the current page\n      });\n      apiRef.current.setSelectionModel(firstSelectableRow !== undefined ? [firstSelectableRow] : []);\n    }\n  }, [apiRef, canHaveMultipleSelection, checkboxSelection, disableMultipleSelection, isRowSelectable, pagination, paginationMode]);\n};","map":{"version":3,"sources":["C:/pproject-files/new-app/node_modules/@mui/x-data-grid/hooks/features/selection/useGridSelection.js"],"names":["_extends","React","GridEvents","useGridApiEventHandler","useGridApiMethod","useGridLogger","gridRowsLookupSelector","isGridCellRoot","gridSelectionStateSelector","selectedGridRowsSelector","selectedIdsLookupSelector","gridPaginatedVisibleSortedGridRowIdsSelector","gridVisibleSortedRowIdsSelector","GRID_CHECKBOX_SELECTION_COL_DEF","GRID_ACTIONS_COLUMN_TYPE","GridCellModes","isKeyboardEvent","getVisibleRows","getSelectionModelPropValue","selectionModelProp","prevSelectionModel","Array","isArray","selectionStateInitializer","state","props","_getSelectionModelPro","selection","selectionModel","useGridSelection","apiRef","logger","propSelectionModel","useMemo","current","lastRowToggled","useRef","unstable_updateControlState","stateId","propModel","propOnChange","onSelectionModelChange","stateSelector","changeEvent","selectionChange","checkboxSelection","disableMultipleSelection","disableSelectionOnClick","isRowSelectable","pagination","paginationMode","canHaveMultipleSelection","expandRowRangeSelection","useCallback","id","_lastRowToggled$curre","endId","startId","isSelected","isRowSelected","visibleRowIds","startIndex","findIndex","rowId","endIndex","selectRowRange","setSelectionModel","model","currentModel","debug","setState","forceUpdate","includes","getSelectedRows","selectRow","resetSelection","getRowParams","newSelection","filter","el","push","isSelectionValid","length","selectRows","ids","selectableIds","selectionLookup","forEach","Object","values","getRow","indexOf","start","end","rowsBetweenStartAndEnd","slice","selectionApi","removeOutdatedSelection","currentSelection","rowsLookup","hasChanged","handleSingleRowSelection","event","hasCtrlKey","metaKey","ctrlKey","isMultipleSelectionDisabled","handleCellClick","params","field","column","getColumn","type","shiftKey","preventSelectionOnShift","_window$getSelection","window","getSelection","removeAllRanges","handleRowSelectionCheckboxChange","nativeEvent","value","handleHeaderSelectionCheckboxChange","shouldLimitSelectionToCurrentPage","checkboxSelectionVisibleOnly","rowsToBeSelected","handleCellKeyDown","target","cellParams","getCellParams","isEditMode","cellMode","Edit","key","preventDefault","toLowerCase","getAllRowIds","visibleRowsSet","cellClick","rowSelectionCheckboxChange","headerSelectionCheckboxChange","cellMouseDown","cellKeyDown","useEffect","undefined","isStateControlled","currentPageRows","rows","currentPageRowsLookup","reduce","acc","firstSelectableRow","find","isSelectable"],"mappings":"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","sourcesContent":["import _extends from \"@babel/runtime/helpers/esm/extends\";\nimport * as React from 'react';\nimport { GridEvents } from '../../../models/events';\nimport { useGridApiEventHandler } from '../../utils/useGridApiEventHandler';\nimport { useGridApiMethod } from '../../utils/useGridApiMethod';\nimport { useGridLogger } from '../../utils/useGridLogger';\nimport { gridRowsLookupSelector } from '../rows/gridRowsSelector';\nimport { isGridCellRoot } from '../../../utils/domUtils';\nimport { gridSelectionStateSelector, selectedGridRowsSelector, selectedIdsLookupSelector } from './gridSelectionSelector';\nimport { gridPaginatedVisibleSortedGridRowIdsSelector } from '../pagination';\nimport { gridVisibleSortedRowIdsSelector } from '../filter/gridFilterSelector';\nimport { GRID_CHECKBOX_SELECTION_COL_DEF, GRID_ACTIONS_COLUMN_TYPE } from '../../../colDef';\nimport { GridCellModes } from '../../../models/gridEditRowModel';\nimport { isKeyboardEvent } from '../../../utils/keyboardUtils';\nimport { getVisibleRows } from '../../utils/useGridVisibleRows';\n\nconst getSelectionModelPropValue = (selectionModelProp, prevSelectionModel) => {\n  if (selectionModelProp == null) {\n    return selectionModelProp;\n  }\n\n  if (Array.isArray(selectionModelProp)) {\n    return selectionModelProp;\n  }\n\n  if (prevSelectionModel && prevSelectionModel[0] === selectionModelProp) {\n    return prevSelectionModel;\n  }\n\n  return [selectionModelProp];\n};\n\nexport const selectionStateInitializer = (state, props) => {\n  var _getSelectionModelPro;\n\n  return _extends({}, state, {\n    selection: (_getSelectionModelPro = getSelectionModelPropValue(props.selectionModel)) != null ? _getSelectionModelPro : []\n  });\n};\n/**\n * @requires useGridRows (state, method)\n * @requires useGridParamsApi (method)\n */\n\nexport const useGridSelection = (apiRef, props) => {\n  const logger = useGridLogger(apiRef, 'useGridSelection');\n  const propSelectionModel = React.useMemo(() => {\n    return getSelectionModelPropValue(props.selectionModel, gridSelectionStateSelector(apiRef.current.state));\n  }, [apiRef, props.selectionModel]);\n  const lastRowToggled = React.useRef(null);\n  apiRef.current.unstable_updateControlState({\n    stateId: 'selection',\n    propModel: propSelectionModel,\n    propOnChange: props.onSelectionModelChange,\n    stateSelector: gridSelectionStateSelector,\n    changeEvent: GridEvents.selectionChange\n  });\n  const {\n    checkboxSelection,\n    disableMultipleSelection,\n    disableSelectionOnClick,\n    isRowSelectable,\n    pagination,\n    paginationMode\n  } = props;\n  const canHaveMultipleSelection = !disableMultipleSelection || checkboxSelection;\n  const expandRowRangeSelection = React.useCallback(id => {\n    var _lastRowToggled$curre;\n\n    let endId = id;\n    const startId = (_lastRowToggled$curre = lastRowToggled.current) != null ? _lastRowToggled$curre : id;\n    const isSelected = apiRef.current.isRowSelected(id);\n\n    if (isSelected) {\n      const visibleRowIds = gridVisibleSortedRowIdsSelector(apiRef);\n      const startIndex = visibleRowIds.findIndex(rowId => rowId === startId);\n      const endIndex = visibleRowIds.findIndex(rowId => rowId === endId);\n\n      if (startIndex > endIndex) {\n        endId = visibleRowIds[endIndex + 1];\n      } else {\n        endId = visibleRowIds[endIndex - 1];\n      }\n    }\n\n    lastRowToggled.current = id;\n    apiRef.current.selectRowRange({\n      startId,\n      endId\n    }, !isSelected);\n  }, [apiRef]);\n  /**\n   * API METHODS\n   */\n\n  const setSelectionModel = React.useCallback(model => {\n    const currentModel = gridSelectionStateSelector(apiRef.current.state);\n\n    if (currentModel !== model) {\n      logger.debug(`Setting selection model`);\n      apiRef.current.setState(state => _extends({}, state, {\n        selection: model\n      }));\n      apiRef.current.forceUpdate();\n    }\n  }, [apiRef, logger]);\n  const isRowSelected = React.useCallback(id => gridSelectionStateSelector(apiRef.current.state).includes(id), [apiRef]);\n  const getSelectedRows = React.useCallback(() => selectedGridRowsSelector(apiRef), [apiRef]);\n  const selectRow = React.useCallback((id, isSelected = true, resetSelection = false) => {\n    if (isRowSelectable && !isRowSelectable(apiRef.current.getRowParams(id))) {\n      return;\n    }\n\n    lastRowToggled.current = id;\n\n    if (resetSelection) {\n      logger.debug(`Setting selection for row ${id}`);\n      apiRef.current.setSelectionModel(isSelected ? [id] : []);\n    } else {\n      logger.debug(`Toggling selection for row ${id}`);\n      const selection = gridSelectionStateSelector(apiRef.current.state);\n      const newSelection = selection.filter(el => el !== id);\n\n      if (isSelected) {\n        newSelection.push(id);\n      }\n\n      const isSelectionValid = newSelection.length < 2 || canHaveMultipleSelection;\n\n      if (isSelectionValid) {\n        apiRef.current.setSelectionModel(newSelection);\n      }\n    }\n  }, [apiRef, isRowSelectable, logger, canHaveMultipleSelection]);\n  const selectRows = React.useCallback((ids, isSelected = true, resetSelection = false) => {\n    logger.debug(`Setting selection for several rows`);\n    const selectableIds = isRowSelectable ? ids.filter(id => isRowSelectable(apiRef.current.getRowParams(id))) : ids;\n    let newSelection;\n\n    if (resetSelection) {\n      newSelection = isSelected ? selectableIds : [];\n    } else {\n      // We clone the existing object to avoid mutating the same object returned by the selector to others part of the project\n      const selectionLookup = _extends({}, selectedIdsLookupSelector(apiRef));\n\n      selectableIds.forEach(id => {\n        if (isSelected) {\n          selectionLookup[id] = id;\n        } else {\n          delete selectionLookup[id];\n        }\n      });\n      newSelection = Object.values(selectionLookup);\n    }\n\n    const isSelectionValid = newSelection.length < 2 || canHaveMultipleSelection;\n\n    if (isSelectionValid) {\n      apiRef.current.setSelectionModel(newSelection);\n    }\n  }, [apiRef, isRowSelectable, logger, canHaveMultipleSelection]);\n  const selectRowRange = React.useCallback(({\n    startId,\n    endId\n  }, isSelected = true, resetSelection) => {\n    if (!apiRef.current.getRow(startId) || !apiRef.current.getRow(endId)) {\n      return;\n    }\n\n    logger.debug(`Expanding selection from row ${startId} to row ${endId}`);\n    const visibleRowIds = gridVisibleSortedRowIdsSelector(apiRef);\n    const startIndex = visibleRowIds.indexOf(startId);\n    const endIndex = visibleRowIds.indexOf(endId);\n    const [start, end] = startIndex > endIndex ? [endIndex, startIndex] : [startIndex, endIndex];\n    const rowsBetweenStartAndEnd = visibleRowIds.slice(start, end + 1);\n    apiRef.current.selectRows(rowsBetweenStartAndEnd, isSelected, resetSelection);\n  }, [apiRef, logger]);\n  const selectionApi = {\n    selectRow,\n    selectRows,\n    selectRowRange,\n    setSelectionModel,\n    getSelectedRows,\n    isRowSelected\n  };\n  useGridApiMethod(apiRef, selectionApi, 'GridSelectionApi');\n  /**\n   * EVENTS\n   */\n\n  const removeOutdatedSelection = React.useCallback(() => {\n    const currentSelection = gridSelectionStateSelector(apiRef.current.state);\n    const rowsLookup = gridRowsLookupSelector(apiRef); // We clone the existing object to avoid mutating the same object returned by the selector to others part of the project\n\n    const selectionLookup = _extends({}, selectedIdsLookupSelector(apiRef));\n\n    let hasChanged = false;\n    currentSelection.forEach(id => {\n      if (!rowsLookup[id]) {\n        delete selectionLookup[id];\n        hasChanged = true;\n      }\n    });\n\n    if (hasChanged) {\n      apiRef.current.setSelectionModel(Object.values(selectionLookup));\n    }\n  }, [apiRef]);\n  const handleSingleRowSelection = React.useCallback((id, event) => {\n    const hasCtrlKey = event.metaKey || event.ctrlKey; // multiple selection is only allowed if:\n    // - it is a checkboxSelection\n    // - it is a keyboard selection\n    // - CTRL is pressed\n\n    const isMultipleSelectionDisabled = !checkboxSelection && !hasCtrlKey && !isKeyboardEvent(event);\n    const resetSelection = !canHaveMultipleSelection || isMultipleSelectionDisabled;\n    const isSelected = apiRef.current.isRowSelected(id);\n\n    if (resetSelection) {\n      apiRef.current.selectRow(id, !isMultipleSelectionDisabled ? !isSelected : true, true);\n    } else {\n      apiRef.current.selectRow(id, !isSelected, false);\n    }\n  }, [apiRef, canHaveMultipleSelection, checkboxSelection]);\n  const handleCellClick = React.useCallback((params, event) => {\n    if (disableSelectionOnClick) {\n      return;\n    }\n\n    if (params.field === GRID_CHECKBOX_SELECTION_COL_DEF.field) {\n      // click on checkbox should not trigger row selection\n      return;\n    }\n\n    if (params.field === '__detail_panel_toggle__') {\n      // click to open the detail panel should not select the row\n      return;\n    }\n\n    if (params.field) {\n      const column = apiRef.current.getColumn(params.field);\n\n      if (column.type === GRID_ACTIONS_COLUMN_TYPE) {\n        return;\n      }\n    }\n\n    if (event.shiftKey && (canHaveMultipleSelection || checkboxSelection)) {\n      expandRowRangeSelection(params.id);\n    } else {\n      handleSingleRowSelection(params.id, event);\n    }\n  }, [disableSelectionOnClick, canHaveMultipleSelection, checkboxSelection, apiRef, expandRowRangeSelection, handleSingleRowSelection]);\n  const preventSelectionOnShift = React.useCallback((params, event) => {\n    if (canHaveMultipleSelection && event.shiftKey) {\n      var _window$getSelection;\n\n      (_window$getSelection = window.getSelection()) == null ? void 0 : _window$getSelection.removeAllRanges();\n    }\n  }, [canHaveMultipleSelection]);\n  const handleRowSelectionCheckboxChange = React.useCallback((params, event) => {\n    if (event.nativeEvent.shiftKey) {\n      expandRowRangeSelection(params.id);\n    } else {\n      apiRef.current.selectRow(params.id, params.value);\n    }\n  }, [apiRef, expandRowRangeSelection]);\n  const handleHeaderSelectionCheckboxChange = React.useCallback(params => {\n    const shouldLimitSelectionToCurrentPage = props.checkboxSelectionVisibleOnly && props.pagination;\n    const rowsToBeSelected = shouldLimitSelectionToCurrentPage ? gridPaginatedVisibleSortedGridRowIdsSelector(apiRef) : gridVisibleSortedRowIdsSelector(apiRef);\n    apiRef.current.selectRows(rowsToBeSelected, params.value);\n  }, [apiRef, props.checkboxSelectionVisibleOnly, props.pagination]);\n  const handleCellKeyDown = React.useCallback((params, event) => {\n    // Ignore portal\n    // Do not apply shortcuts if the focus is not on the cell root component\n    // TODO replace with !event.currentTarget.contains(event.target as Element)\n    if (!isGridCellRoot(event.target)) {\n      return;\n    } // Get the most recent params because the cell mode may have changed by another listener\n\n\n    const cellParams = apiRef.current.getCellParams(params.id, params.field);\n    const isEditMode = cellParams.cellMode === GridCellModes.Edit;\n\n    if (isEditMode) {\n      return;\n    }\n\n    if (event.key === ' ' && event.shiftKey) {\n      event.preventDefault();\n      handleSingleRowSelection(cellParams.id, event);\n      return;\n    }\n\n    if (event.key.toLowerCase() === 'a' && (event.ctrlKey || event.metaKey)) {\n      event.preventDefault();\n      selectRows(apiRef.current.getAllRowIds(), true);\n    }\n  }, [apiRef, handleSingleRowSelection, selectRows]);\n  useGridApiEventHandler(apiRef, GridEvents.visibleRowsSet, removeOutdatedSelection);\n  useGridApiEventHandler(apiRef, GridEvents.cellClick, handleCellClick);\n  useGridApiEventHandler(apiRef, GridEvents.rowSelectionCheckboxChange, handleRowSelectionCheckboxChange);\n  useGridApiEventHandler(apiRef, GridEvents.headerSelectionCheckboxChange, handleHeaderSelectionCheckboxChange);\n  useGridApiEventHandler(apiRef, GridEvents.cellMouseDown, preventSelectionOnShift);\n  useGridApiEventHandler(apiRef, GridEvents.cellKeyDown, handleCellKeyDown);\n  /**\n   * EFFECTS\n   */\n\n  React.useEffect(() => {\n    if (propSelectionModel !== undefined) {\n      apiRef.current.setSelectionModel(propSelectionModel);\n    }\n  }, [apiRef, propSelectionModel]);\n  const isStateControlled = propSelectionModel != null;\n  React.useEffect(() => {\n    if (isStateControlled) {\n      return;\n    } // isRowSelectable changed\n\n\n    const currentSelection = gridSelectionStateSelector(apiRef.current.state);\n\n    if (isRowSelectable) {\n      const newSelection = currentSelection.filter(id => isRowSelectable(apiRef.current.getRowParams(id)));\n\n      if (newSelection.length < currentSelection.length) {\n        apiRef.current.setSelectionModel(newSelection);\n      }\n    }\n  }, [apiRef, isRowSelectable, isStateControlled]);\n  React.useEffect(() => {\n    const currentSelection = gridSelectionStateSelector(apiRef.current.state);\n\n    if (!canHaveMultipleSelection && currentSelection.length > 1) {\n      const {\n        rows: currentPageRows\n      } = getVisibleRows(apiRef, {\n        pagination,\n        paginationMode\n      });\n      const currentPageRowsLookup = currentPageRows.reduce((acc, {\n        id\n      }) => {\n        acc[id] = true;\n        return acc;\n      }, {});\n      const firstSelectableRow = currentSelection.find(id => {\n        let isSelectable = true;\n\n        if (isRowSelectable) {\n          isSelectable = isRowSelectable(apiRef.current.getRowParams(id));\n        }\n\n        return isSelectable && currentPageRowsLookup[id]; // Check if the row is in the current page\n      });\n      apiRef.current.setSelectionModel(firstSelectableRow !== undefined ? [firstSelectableRow] : []);\n    }\n  }, [apiRef, canHaveMultipleSelection, checkboxSelection, disableMultipleSelection, isRowSelectable, pagination, paginationMode]);\n};"]},"metadata":{},"sourceType":"module"}